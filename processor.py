import os
import csv

from tqdm import tqdm


def get_feature_vector(folder_path: str):
    """
    Features
        - vbaProject.bin size / Full size
        - vbaProject.bin size / word folder size
        - vbaProject.bin size / document.xml size
        - vbaProject.bin + vbaData.xml size / Full size
        - vbaProject.bin + vbaData.xml size / word folder size
        - vbaProject.bin + vbaData.xml size / document.xml size
        - postscript file size / Full size
        - postscript file size / word folder size
        - postscript file size / media folder size
        - _rels folders size / Full size
        - _rels folders size / word folder size
        - _rels folders size / document.xml size
    :param folder_path: target folder to make feature vector(file_bmi)
    :return: (11, 1) shape vectorized file_bmi
    """
    os.path.basename(folder_path)
    full_size = 0.0001
    word_folder_size = 0.0001
    document_size = 0.0001
    media_size = 0.0001
    vba_project_size = 0.0001
    vba_data_size = 0.0001
    postscript_size = 0.0001
    rels_size = 0.0001
    for path, dirs, files in os.walk(folder_path):
        for file in files:
            full_size += os.path.getsize(path + os.sep + file)
            if file == 'vbaProject.bin':
                vba_project_size += os.path.getsize(path + os.sep + file)
            elif file == 'vbaData.xml':
                vba_data_size += os.path.getsize(path + os.sep + file)
            elif file == 'document.xml':
                document_size += os.path.getsize(path + os.sep + file)
            elif file.count('.eps') != 0:
                postscript_size += os.path.getsize(path + os.sep + file)

    for path, dirs, files in os.walk(folder_path + os.sep + 'word'):
        for file in files:
            word_folder_size += os.path.getsize(path + os.sep + file)

    for path, dirs, files in os.walk(folder_path + os.sep + 'word' + os.sep + '_rels'):
        for file in files:
            rels_size += os.path.getsize(path + os.sep + file)

    for path, dirs, files in os.walk(folder_path + os.sep + 'word' + os.sep + 'media'):
        for file in files:
            media_size += os.path.getsize(path + os.sep + file)

    for path, dirs, files in os.walk(folder_path + os.sep + '_rels'):
        for file in files:
            rels_size += os.path.getsize(path + os.sep + file)
    try:
        feature_vector = [
            vba_project_size / word_folder_size,
            vba_project_size / document_size,
            (vba_project_size + vba_data_size) / full_size,
            (vba_project_size + vba_data_size) / word_folder_size,
            (vba_project_size + vba_data_size) / document_size,
            postscript_size / full_size,
            postscript_size / word_folder_size,
            postscript_size / media_size,
            rels_size / full_size,
            rels_size / word_folder_size,
            rels_size / document_size
        ]
        return feature_vector
    except Exception as e:
        print(folder_path, e)


def main():
    with open(r'C:\Users\seclab\PycharmProjects\Malware_BMI\train.csv', 'w') as f:
        root = r'C:\Users\seclab\PycharmProjects\Malware_BMI\source\train\benign'
        for sub in tqdm(os.listdir(root)):
            f.write(root + os.sep + sub + ',0' + '\n')

        root = r'C:\Users\seclab\PycharmProjects\Malware_BMI\source\train\mal'
        for sub in tqdm(os.listdir(root)):
            f.write(root + os.sep + sub + ',1' + '\n')


if __name__ == '__main__':
    main()
    # exit()
